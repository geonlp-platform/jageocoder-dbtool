<!DOCTYPE html>
<html>
<head>
<title>manual.markdown</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h2 id="jageocoder-%E7%94%A8%E8%BE%9E%E6%9B%B8%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%83%84%E3%83%BC%E3%83%AB-jageocoder-dbtool">Jageocoder 用辞書データベースツール jageocoder-dbtool</h2>
<h1 id="%E3%81%93%E3%81%AE%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">このソフトウェアについて</h1>
<p>Jageocoder-dbtool (本ソフト) は、地図データから <a href="https://jageocoder.info-proto.com/">Jageocoder</a> 用の住所データベースを作成するソフトウェアです。</p>
<h2 id="%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%99%E3%82%8B%E5%88%A9%E7%94%A8%E8%80%85">対象とする利用者</h2>
<p>一般的な住所を解析したり、対応する経緯度を取得したい場合は、本ソフトを利用して住所データベースを作る必要はありません。すでに作成済みの住所データベースを <a href="https://www.info-proto.com/static/jageocoder/latest/">Jageocoder データファイル一覧</a> で配布しているので、そちらからダウンロードしてください。</p>
<p>配布しているデータファイルは国の機関が公開しているオープンデータから作成しているため、市販されている地図データに比べると精度が低かったり、網羅範囲が狭いことがあります。有償の地図データをお持ちであったり、独自に調査して作成した地図データがあり、その地図に対応する住所データベースを作りたい場合に本ソフトを利用してください。</p>
<h2 id="%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%99%E3%82%8B%E5%8B%95%E4%BD%9C%E7%92%B0%E5%A2%83">対象とする動作環境</h2>
<p>本ソフトを実行するには、 Python 3.10, 3.11, 3.12 が動作する環境が必要です。 3.13 以降では現時点では動作しません。</p>
<p>Windows 上のコマンドプロンプト、各種 Linux、 MacOS X で動作確認しています。</p>
<h1 id="%E5%AF%BE%E8%B1%A1%E3%81%A8%E3%81%99%E3%82%8B%E5%9C%B0%E5%9B%B3%E3%83%87%E3%83%BC%E3%82%BF">対象とする地図データ</h1>
<p>本ソフトでは、 <a href="https://geojson.org/">GeoJSON</a> 形式の地図データから、 Jageocoder 用の住所データベースを作成します。利用したい地図データが GeoJSON 形式ではない場合、お手数ですが <a href="https://qgis.org/">QGIS</a> などの GIS ソフトウェアを利用して地図データを読み込み、 GeoJSON 形式でエクスポートしてください。</p>
<p>GeoJSON データにもいろいろな種類がありますが、本ソフトが対応しているのは「 Point, Polygon, Multipolygon をジオメトリに持つ Feature のリスト」 (1行に1オブジェクトを含む JSONL フォーマットのファイル) または「Point, Polygon, Multipolygon をジオメトリに持つ FeatureCollection」です。 LineString をジオメトリに持つデータ (たとえば道路データなど) は利用できません。</p>
<p>GeoJSON データの座標参照系は WGS84 (RFC7946) 、文字エンコーディングは UTF-8 (RFC8259) である必要があります。利用したい地図データが異なる座標参照系や文字エンコーディングを利用している場合は、 GIS ソフトウェア等を利用して変換してください。</p>
<h1 id="%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E6%89%8B%E9%A0%86">インストール手順</h1>
<h2 id="python-3x-%E4%BB%AE%E6%83%B3%E7%92%B0%E5%A2%83%E3%81%AE%E4%BD%9C%E6%88%90">Python 3.x 仮想環境の作成</h2>
<p>Python 3.x のインストール手順と仮想環境の作成方法が分からない場合は、環境に合わせて別紙を参照してください。本ソフトが動作する Python のバージョンは 3.10, 3.11, 3.12 です。</p>
<ul>
<li>Linux の場合: &quot;Python のインストールと仮想環境作成手順 (Linux)&quot;</li>
<li>MacOSX の場合: &quot;Python のインストールと仮想環境作成手順 (MacOSX)&quot;</li>
<li>Windows コマンドプロンプトの場合: &quot;Python のインストールと仮想環境作成手順 (cmd.exe)&quot;</li>
</ul>
<h2 id="%E6%9C%AC%E3%82%BD%E3%83%95%E3%83%88%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">本ソフトのインストール</h2>
<p>本ソフトは Python の公式ソフトウェアリポジトリである <a href="https://pypi.org/">PyPI</a> からダウンロード、インストールします。仮想環境を有効化した状態で次のコマンドを実行してください。</p>
<pre class="hljs"><code><div>(.venv) pip install jageocoder-dbtool
</div></code></pre>
<p>インストールに成功すると &quot;dbtool&quot; コマンドが実行できるようになります。実行すると簡単なヘルプが表示されます。</p>
<blockquote>
<p>インストールするパッケージ名は &quot;jageocoder-(ハイフン)dbtool&quot; 、実行するコマンドは &quot;dbtool&quot; です。</p>
</blockquote>
<pre class="hljs"><code><div>(.venv) dbtool
Usage:
  dbtool ( -h | --help )
  dbtool ( -v | --version )
  dbtool check [-d] [--output=&lt;file&gt;] [--codekey=&lt;codekey&gt;] [--code=&lt;attrs&gt;] [--pref=&lt;attrs&gt;] [--county=&lt;attrs&gt;] [--city=&lt;attrs&gt;] [--ward=&lt;attrs&gt;] [--oaza=&lt;attrs&gt;] [--aza=&lt;attrs&gt;] [--block=&lt;attrs&gt;] [--bld=&lt;attrs&gt;] &lt;geojsonfile&gt;...
  dbtool geojson2db [-d] [--text-dir=&lt;dir&gt;] [--db-dir=&lt;dir&gt;] [--id=&lt;id&gt;] [--title=&lt;title&gt;] [--url=&lt;url&gt;] [--codekey=&lt;codekey&gt;] [--code=&lt;attrs&gt;] [--pref=&lt;attrs&gt;] [--county=&lt;attrs&gt;] [--city=&lt;attrs&gt;] [--ward=&lt;attrs&gt;] [--oaza=&lt;attrs&gt;] [--aza=&lt;attrs&gt;] [--block=&lt;attrs&gt;] [--bld=&lt;attrs&gt;] &lt;geojsonfile&gt;...
  dbtool geojson2text [-d] --text-dir=&lt;dir&gt; [--id=&lt;id&gt;] [--title=&lt;title&gt;] [--url=&lt;url&gt;] [--codekey=&lt;codekey&gt;] [--code=&lt;attrs&gt;] [--pref=&lt;attrs&gt;] [--county=&lt;attrs&gt;] [--city=&lt;attrs&gt;] [--ward=&lt;attrs&gt;] [--oaza=&lt;attrs&gt;] [--aza=&lt;attrs&gt;] [--block=&lt;attrs&gt;] [--bld=&lt;attrs&gt;] &lt;geojsonfile&gt;...
  dbtool text2db [-d] [--db-dir=&lt;dir&gt;] (--text-dir=&lt;dir&gt;|&lt;textfile&gt;...)
</div></code></pre>
<h2 id="%E5%8F%82%E8%80%83-%E6%9C%AC%E3%82%BD%E3%83%95%E3%83%88%E3%81%AE%E3%82%A2%E3%83%B3%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB">(参考) 本ソフトのアンインストール</h2>
<p>本ソフトをもう利用しない場合は、仮想環境を無効化してから &quot;.venv&quot; ディレクトリごと削除してください。</p>
<p>Linux, MacOSX の場合は &quot;rm -r&quot; でディレクトリ以下を削除します。</p>
<pre class="hljs"><code><div>(.venv) deactivate
rm -r .venv
</div></code></pre>
<p>Windows cmd.com の場合は &quot;rmdir /S&quot; でディレクトリを中身ごと削除します。</p>
<pre class="hljs"><code><div>(.venv) deactivate
&gt; rmdir /S .venv
</div></code></pre>
<h2 id="%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E4%B8%80%E8%A6%A7">コマンド一覧</h2>
<p>本ソフトで利用できる機能とコマンドは次の通りです。</p>
<ul>
<li>
<p>&quot;dbtool geojson2db ...&quot;</p>
<p><a href="https://geojson.org/">GeoJSON</a> 形式の地図データから、 Jageocoder 住所データベースを作成します。</p>
</li>
<li>
<p>&quot;dbtool check ...&quot;</p>
<p>GeoJSON を住所データに変換する際のパラメータおよび変換結果を確認します。代表点の座標をジオメトリとする Point 形式の GeoJSON (JSONL) ファイルを出力します。詳細は「具体例」を参照してください。</p>
</li>
<li>
<p>&quot;dbtool geojson2text ...&quot;</p>
<p>GeoJSON 形式の地図データから、 Jageocoder 住所データベース用のテキスト形式データを作成します。「テキスト形式データ」はデータベースダンプに相当するもので、そのままでは Jageocoder で利用できませんが、テキスト形式データがあれば住所データベースを作ることができます。</p>
</li>
<li>
<p>&quot;dbtool text2db ...&quot;</p>
<p>テキスト形式データから住所データベースを作成します。複数のテキスト形式データをまとめて住所データベースに変換すると、統合検索が可能な住所データベースを作ることができます。</p>
</li>
</ul>
<h2 id="%E4%BD%8F%E6%89%80%E3%83%AC%E3%83%99%E3%83%AB%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3">住所レベル割り当てオプション</h2>
<p>&quot;geojson2db&quot;・&quot;check&quot;・&quot;geojson2text&quot; コマンドでは、GeoJSON 地図データに含まれる属性を都道府県や市区町村といった住所の要素に割り当てる必要があります。ここではこれらのコマンドで共通の、住所レベルの割り当てに利用するオプションについて説明します。</p>
<p>Jageocoder は住所を以下のレベルに分けて管理します。</p>
<ol>
<li>Pref: 都道府県  (「北海道」など)</li>
<li>County: 郡・支庁・島 (「幌泉郡」「八丈島」など)</li>
<li>City: 市町村・特別区 (「室蘭市」「千代田区」など)</li>
<li>Ward: 政令市の区 (「青葉区」「天王寺区」など)</li>
<li>Oaza: 大字 (「市場町切幡」など)</li>
<li>Aza: 小字・丁目 (「字古田」など)</li>
<li>Block: 街区・地番 (「1番」「201番地」など)</li>
<li>Bld: 住居番号・枝番 (「1号」「24」など)</li>
</ol>
<p>たとえば北海道のえりも町役場の住所「北海道幌泉郡えりも町字本町206番地」は、 Jageocoder では</p>
<pre class="hljs"><code><div>{&quot;pref&quot;:&quot;北海道&quot;, &quot;county&quot;:&quot;幌泉郡&quot;, &quot;city&quot;:&quot;えりも町&quot;, &quot;oaza&quot;:&quot;字本町&quot;, &quot;block&quot;:&quot;206番地&quot;}
</div></code></pre>
<p>と分割し、宮城県仙台市の青葉区役所の住所「宮城県仙台市青葉区国分町3丁目7番1号」は</p>
<pre class="hljs"><code><div>{&quot;pref&quot;:&quot;宮城県&quot;, &quot;city&quot;:&quot;仙台市&quot;, &quot;ward&quot;:&quot;青葉区&quot;, &quot;oaza&quot;:&quot;国分町&quot;, &quot;aza&quot;:&quot;3丁目&quot;, &quot;block&quot;:&quot;7番&quot;, &quot;bld&quot;:&quot;1号&quot;}
</div></code></pre>
<p>と分割します。</p>
<p>住所をどのように分割するか、レベルごとの名称をどうするかについては決まったルールがないため、地図データによっていろいろな書き方があります。そこで本ソフトでは、オプションパラメータを使って「地図データのどの属性が Jageocoder のどの住所レベルに該当するか」を指定する必要があります。</p>
<p>オプションパラメータ名は上のレベル分けに記載した &quot;pref&quot;, &quot;county&quot; などの前に &quot;--&quot; を付け、&quot;パラメータ名=属性名&quot; という形式で指定してください。たとえば地図データの「丁目」属性を Aza レベルに割り当てたければ、 &quot;--aza=丁目&quot; のようになります。</p>
<p>地図データに該当する属性が存在しない場合はオプションごと省略できます。たとえば千代田区だけを対象とした地図データであれば county や ward に該当する属性が存在しないでしょう。その場合は &quot;--county&quot; や &quot;--ward&quot; は不要です。都道府県や市町村に該当する属性も省略されていて存在しないかもしれませんが、&quot;--pref&quot; や &quot;--city&quot; を省略してしまうと「東京都千代田区…」から書かれた住所を解析できなくなってしまいます。このような場合には &quot;--pref==東京都 --city==千代田区&quot; のようにイコールを2つ並べて固定値を指定してください。</p>
<p>地図データに該当する属性が存在するけれど接尾辞が省略されている場合もあります。たとえば &quot;chome&quot;という属性があり、そこに &quot;1&quot; という数字だけが記録されている場合、住所の要素としては &quot;1丁目&quot;として登録する必要があります。このように属性の値に文字列を付け加えたいような場合には、&quot;{}&quot; で属性名を囲むことでその属性の値に置き換えられます。 &quot;chome&quot; 属性の値の後ろに「丁目」という文字列を追加して aza レベルに割り当てたい場合は、 &quot;--aza={chome}丁目&quot; と指定します。</p>
<p>なお、アパート・マンション名など、 bld よりも詳細な住所レベルには対応していません。</p>
<h1 id="%E5%85%B7%E4%BD%93%E4%BE%8B">具体例</h1>
<p>ここではオープンデータを利用して実際に住所データベースを作成する手順を説明します。</p>
<h2 id="%E5%9C%B0%E5%9B%B3%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E6%BA%96%E5%82%99">地図データの準備</h2>
<p>サンプルとして、G空間情報センターより「法務省登記所備付地図データ変換済」の北海道室蘭市のデータを利用します (データダウンロードには無償のユーザ登録が必要です)。
https://www.geospatial.jp/ckan/dataset/aigid-moj-01205 を開き、 &quot;01205_室蘭市_公共座標12系_筆R_2024.geojson&quot; リンクからダウンロードに進んでください。 &quot;01205__12_r_2024.geojson&quot; という GeoJSON 形式のファイルがダウンロードできます。</p>
<p>このファイルを QGIS で開き、室蘭市役所付近のポリゴンをクリックすると、次のような属性を持っていることが分かります。</p>
<ul>
<li>ID: H000000072</li>
<li>市区町村C: 01205</li>
<li>大字コード: 017</li>
<li>丁目コード: 000</li>
<li>小字コード: 0000</li>
<li>予備コード: 00</li>
<li>市区町村名: 室蘭市</li>
<li>大字名: 幸町</li>
<li>丁目名: NULL</li>
<li>地番: 130-1</li>
<li>精度区分: 甲二</li>
<li>座標値種別: 測量成果</li>
<li>地図名: H20430201205031</li>
<li>座標系: 公共座標12系</li>
<li>測地系判別: 測量</li>
</ul>
<img src="muroran-chibanzu-2024.jpg" width="100%" />
<p>この地図データから、「室蘭市幸町130-1」を「北海道 / 室蘭市 / 幸町/ 130-1番地」と解析し、ポリゴンの中心付近の経緯度を返すことができる住所データベースを作ります。</p>
<h2 id="%E4%BB%A3%E8%A1%A8%E7%82%B9%E5%BA%A7%E6%A8%99%E3%81%A8%E4%BD%8F%E6%89%80%E3%81%AE%E7%A2%BA%E8%AA%8D">代表点座標と住所の確認</h2>
<p>ダウンロードした GeoJSON ファイルを利用しやすくするため、本ソフトをインストールしたディレクトリにコピーしてください。</p>
<blockquote>
<p>コピーせずに、 GeoJSON ファイルを指定している部分をファイルへのパスに置き換えても動作します。</p>
</blockquote>
<p>Jageocoder は座標を経緯度で管理するため、地図データがポリゴンで提供されている場合、ポリゴン内の１点を代表点として算出してその座標をデータベースに登録します。また、住所を解析した結果からポリゴンを逆引きするには、地図データ中でポリゴンを一意に識別できるコードを登録しておく必要があります。</p>
<p>代表点の位置と識別コード、および元の地図データの属性が住所レベルに正しく割り当てられているかを確認するため、 &quot;dbtool check&quot; コマンドを実行します。</p>
<pre class="hljs"><code><div>dbtool check --code=ID --pref==北海道 --city=市区町村名 --oaza=大字名 --aza=丁目名 --block={地番}番地 01205__12_r_2024.geojson --output=01205__12_r_2024_point.geojsonl
</div></code></pre>
<p>オプションの意味は次の通りです。</p>
<ul>
<li>&quot;--code=ID&quot;: &quot;ID&quot; 属性をこの住所の識別コードとして利用します。</li>
<li>&quot;--pref==北海道&quot;: 入力データには「都道府県」に該当する属性が含まれていないため、 Pref レベルに常に「北海道」を指定します。固定値を指定するので &quot;==&quot; を使います。</li>
<li>&quot;--city=市区町村名&quot;: &quot;市区町村名&quot; 属性を City レベルに割り当てます。</li>
<li>&quot;--oaza=大字名&quot;: &quot;大字名&quot; 属性を Oaza レベルに割り当てます。</li>
<li>&quot;--aza=丁目名&quot;: &quot;丁目名&quot; 属性を Aza レベルに割り当てます。</li>
<li>&quot;--block={地番}番地&quot;: &quot;地番&quot; 属性の値の後ろに「番地」を結合した文字列を Block レベルに割り当てます。</li>
<li>&quot;--output=...&quot;: 割り当てた結果を確認するための GeoJSON データを指定したファイル名に出力します。このオプションを省略すると標準出力 (画面) に表示されます。</li>
</ul>
<p>この例では County・Ward・Bld レベルには何も割り当てられていないため、常に空欄になります。
実行すると &quot;01205__12_r_2024_point.geojsonl&quot; という JSONL 形式のファイルが作成されます。 QGIS で開くと図のように代表点の位置と住所の割り当てを確認することができます。</p>
<img src="muroran-point-2024.jpg" witdh="100%" />
<p>また、 &quot;hcode&quot; という属性に GeoJSON の &quot;ID&quot; の値が識別コードとして入っていることも確認できます。</p>
<blockquote>
<p>この属性名を変更したい場合は、 &quot;--codekey=muroran&quot; のように指定してください。省略すると &quot;hcode&quot; になります。</p>
</blockquote>
<h2 id="geojson-%E3%81%8B%E3%82%89%E4%BD%8F%E6%89%80%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%82%92%E6%A7%8B%E7%AF%89">GeoJSON から住所データベースを構築</h2>
<p>代表点の位置や、地図データの属性が住所レベルに正しく割り当てられていることを確認したら、住所データベースを作成します。</p>
<p>&quot;check&quot; の代わりに &quot;geojson2db&quot; を指定します。また、 &quot;--output&quot; は確認用 GeoJSON ファイル名を指定するオプションなので、 &quot;geojson2db&quot; では指定できません。削除してください。</p>
<pre class="hljs"><code><div>dbtool geojson2db --code=ID --pref==北海道 --city=市区町村名 --oaza=大字名 --aza=丁目名 --block={地番}番地 01205__12_r_2024.geojson
</div></code></pre>
<p>このコマンドを実行すると、 &quot;db&quot; ディレクトリに住所データベースが作成されます。住所データベースは複数のファイルを含むファイルツリーで、 &quot;db&quot; ディレクトリが住所データベースそのものです。この住所データベースを利用して、実際に室蘭市の住所が解析できることを確認します。</p>
<pre class="hljs"><code><div>jageocoder search --db-dir=db 室蘭市幸町130-1
{&quot;matched&quot;: &quot;室蘭市幸町130-1&quot;, &quot;candidates&quot;: [{&quot;id&quot;: 19381, &quot;name&quot;: &quot;130-1番地&quot;, &quot;x&quot;: 140.9738006591797, &quot;y&quot;: 42.31498336791992, &quot;level&quot;: 7, &quot;priority&quot;: 99, &quot;note&quot;: &quot;hcode:H000000072&quot;, &quot;fullname&quot;: [&quot;北海道&quot;, &quot;室蘭市&quot;, &quot;幸町&quot;, &quot;130-1番地&quot;]}]}
</div></code></pre>
<p>&quot;fullname&quot; の値が期待した通り「北海道 / 室蘭市 / 幸町/ 130-1番地」になっています。また、&quot;x&quot;・&quot;y&quot; に代表点の座標が、 &quot;note&quot; に &quot;hcode:H000000072&quot; という形式でポリゴンの識別コードが格納されています。</p>
<p>&quot;db&quot; ディレクトリの名前を変更したり移動しても住所データベースとして機能しますが、最初から出力するディレクトリ名を指定したければ &quot;--db-dir=murorandb&quot; のようにオプションを追加してください。</p>
<p>リバースジオコーディング (経緯度から住所を検索) もできます。</p>
<blockquote>
<p>最初にリバースジオコーディングを実行する時は RTree を作成するため少し時間がかかります。</p>
</blockquote>
<pre class="hljs"><code><div>jageocoder reverse --db-dir=db --level=8 140.97380 42.31498
[{&quot;candidate&quot;: {&quot;id&quot;: 19381, &quot;name&quot;: &quot;130-1番地&quot;, &quot;x&quot;: 140.9738006591797, &quot;y&quot;: 42.31498336791992, &quot;level&quot;: 7, &quot;priority&quot;: 99, &quot;note&quot;: &quot;hcode:H000000072&quot;, &quot;fullname&quot;: [&quot;北海道&quot;, &quot;室蘭市&quot;, &quot;幸町&quot;, &quot;130-1番地&quot;]}, &quot;dist&quot;: 0.3780329387571648}, {&quot;candidate&quot;: {&quot;id&quot;: 23185, &quot;name&quot;: &quot;2-14番地&quot;, &quot;x&quot;: 140.9730987548828, &quot;y&quot;: 42.314605712890625, &quot;level&quot;: 7, &quot;priority&quot;: 99, &quot;note&quot;: &quot;hcode:H000001791&quot;, &quot;fullname&quot;: [&quot;北海道&quot;, &quot;室蘭市&quot;, &quot;本町&quot;, &quot;２丁目&quot;, &quot;2-14番地&quot;]}, &quot;dist&quot;: 71.20881235331073}, {&quot;candidate&quot;: {&quot;id&quot;: 19400, &quot;name&quot;: &quot;202番地&quot;, &quot;x&quot;: 140.97422790527344, &quot;y&quot;: 42.31449508666992, &quot;level&quot;: 7, &quot;priority&quot;: 99, &quot;note&quot;: &quot;hcode:H000000053&quot;, &quot;fullname&quot;: [&quot;北海道&quot;, &quot;室蘭市&quot;, &quot;幸町&quot;, &quot;202番地&quot;]}, &quot;dist&quot;: 64.38778831053295}]
</div></code></pre>
<p>指定した座標 (lon:140.97380, lat:42.31498) に最寄りの住所として [&quot;北海道&quot;, &quot;室蘭市&quot;, &quot;幸町&quot;, &quot;130-1番地&quot;] が検索できています。</p>
<h1 id="%E3%82%88%E3%82%8A%E9%AB%98%E5%BA%A6%E3%81%AA%E4%BD%BF%E3%81%84%E6%96%B9">より高度な使い方</h1>
<p>複数の地図データを利用して、より高度な住所データベースを作成する方法を説明します。</p>
<h2 id="%E8%A4%87%E6%95%B0%E3%81%AE%E5%9C%B0%E5%9B%B3%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%88%A9%E7%94%A8">複数の地図データを利用</h2>
<p>住所データベースを作成する時に、複数の地図データを組み合わせて利用したいことがあります。たとえば室蘭市が公開している
<a href="https://www.geospatial.jp/ckan/dataset/muroranchiban2024">室蘭市地番図2024年</a> には大字の境界を表す &quot;ooaza&quot; レイヤが含まれています。</p>
<img src="muroran-ooaza-2024.jpg" witdh="100%" />
<p>登記所備付地図から作成したデータにこの大字境界ポリゴンから作成したデータを追加することで、大字レベルの住所をより正確に解析することができるようになります。</p>
<div class="note" style="padding:10px; border: solid 1px;">
登記所備付地図から作成した住所データベースには Block レベルのデータしか含まれていませんが、 Oaza レベルの住所を検索することもできます。
<pre class="hljs"><code><div>jageocoder search --db-dir=db 室蘭市幸町
{&quot;matched&quot;: &quot;室蘭市幸町&quot;, &quot;candidates&quot;: [{&quot;id&quot;: 19281, &quot;name&quot;: &quot;幸町&quot;, &quot;x&quot;: 140.97177124023438, &quot;y&quot;: 42.316184997558594, &quot;level&quot;: 5, &quot;priority&quot;: 99, &quot;note&quot;: &quot;&quot;, &quot;fullname&quot;: [&quot;北海道&quot;, &quot;室蘭市&quot;, &quot;幸町&quot;]}]}
</div></code></pre>
<p>この「幸町」の座標は、幸町に含まれる Block レベルのデータのうち文字コード順で最も小さい「室蘭市幸町1-1」から作成しています。検索してみると「室蘭市幸町1-1」の座標と完全に一致していることが分かります。</p>
<pre class="hljs"><code><div>jageocoder search --db-dir=db 室蘭市幸町1-1
{&quot;matched&quot;: &quot;室蘭市幸町1-1&quot;, &quot;candidates&quot;: [{&quot;id&quot;: 19282, &quot;name&quot;: &quot;1-1番地&quot;, &quot;x&quot;: 140.97177124023438, &quot;y&quot;: 42.316184997558594, &quot;level&quot;: 7, &quot;priority&quot;: 99, &quot;note&quot;: &quot;hcode:H000002407&quot;, &quot;fullname&quot;: [&quot;北海道&quot;, &quot;室蘭市&quot;, &quot;幸町&quot;, &quot;1-1番地&quot;]}]}
</div></code></pre>
<p>この座標は大字の中心付近ではなく、端の方にあり、代表点として適切ではありません。大字境界ポリゴンから代表点を作成することでポリゴンの中央付近の座標を返すことができるようになります。</p>
</div>
<p>室蘭市地番図の &quot;ooaza&quot; レイヤを GeoJSON 形式でエクスポートして &quot;muroran_oaza-2024.geojson&quot; というファイルに保存します。 QGIS で開くと「幸町」のポリゴンは次のような属性を持っています。</p>
<ul>
<li>OBJECTID: 9</li>
<li>大字コード: 2180</li>
<li>大字名: 幸町</li>
<li>Shape_Length: 1,859.895140748211</li>
<li>Shape_Area: 101,670.26402171604</li>
</ul>
<p>この GeoJSON の属性を住所レベルに割りあて、代表点座標を計算します。識別コードには「大字コード」を利用し、 codekey として登記所備付地図と重複しないように ooaza を指定します。</p>
<pre class="hljs"><code><div>dbtool check --codekey=ooaza --code=大字コード --pref==北海道 --city==室蘭市 --oaza=大字名 muroran_oaza-2024.geojson --output=muroran_oaza_point.geojsonl
</div></code></pre>
<p>作成した &quot;muroran_oaza_point.geojsonl&quot; を確認すると、代表点は大字ポリゴンの中心にあり、 &quot;ooaza&quot; に大字コードの 2180 が登録されています。</p>
<img src="muroran_oaza_point.jpg" witdh="100%" />
<h2 id="%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E5%BD%A2%E5%BC%8F%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E4%BD%9C%E6%88%90">テキスト形式データを作成</h2>
<p>2つの地図データから住所データベースを作る準備ができましたが、登記所備付地図と室蘭市地番図の大字境界レイヤでは属性の構成が異なるため、 &quot;dbtool convert&quot; コマンドで一度に住所データベースに変換することはできません。たとえば City レベルの住所は、登記所備付地図では &quot;--city=市区町村名&quot; と指定する必要がありますが、室蘭市地番図では &quot;--city==室蘭市&quot; と指定する必要があるからです。</p>
<p>このように構造が異なる複数の地図データから住所データベースを作成したい場合は、 &quot;dbtool geojson2text&quot; コマンドを利用してそれぞれの地図から「テキスト形式データ」を作成します。</p>
<pre class="hljs"><code><div>(登記所備付地図からテキスト形式データを作成)
dbtool geojson2text --codekey=chiban --code=ID --pref==北海道 --city=市区町村名 --oaza=大字名 --aza=丁目名 --block={地番}番地 01205__12_r_2024.geojson
(室蘭市地番図大字境界レイヤからテキスト形式データを作成)
dbtool geojson2text --codekey=ooaza --code=大字コード --pref==北海道 --city==室蘭市 --oaza=大字名 muroran_oaza-2024.geojson
</div></code></pre>
<p>&quot;geojson2text&quot; のオプションは &quot;geojson2db&quot; とほぼ同じですが、データベースディレクトリは指定できません。テキスト形式データを出力するディレクトリは &quot;--text-dir&quot; で指定でき、省略した場合は dbtool コマンドを実行したディレクトリ下の &quot;texts&quot; になります。</p>
<p>作成したテキスト形式データを &quot;dbtool text2db&quot; コマンドで1つの住所データベースにまとめます。 &quot;texts&quot; ディレクトリ内にある全てのテキスト形式データを利用して住所データベースを作るには、次のコマンドを実行します。</p>
<pre class="hljs"><code><div>dbtool text2db --text-dir=texts
</div></code></pre>
<blockquote>
<p>ディレクトリではなくファイル名を &quot;dbtool text2db texts/01205__12_r_2024.txt.bz2 texts/muroran_oaza-2024.txt.bz2&quot; のように指定すると、そのファイルだけ利用して住所データベースを作成できます。</p>
</blockquote>
<p>これで &quot;db&quot; に住所データベースが作成されました。この住所データベースを利用して大字レベルの住所と地番レベルの住所を検索してみます。</p>
<pre class="hljs"><code><div>jageocoder search --db-dir=db 室蘭市幸町
{&quot;matched&quot;: &quot;室蘭市幸町&quot;, &quot;candidates&quot;: [{&quot;id&quot;: 19317, &quot;name&quot;: &quot;幸町&quot;, &quot;x&quot;: 140.97024536132812, &quot;y&quot;: 42.3152961730957, &quot;level&quot;: 5, &quot;priority&quot;: 99, &quot;note&quot;: &quot;ooaza:2180&quot;, &quot;fullname&quot;: [&quot;北海道&quot;, &quot;室蘭市&quot;, &quot;幸町&quot;]}]}
jageocoder search --db-dir=db 室蘭市幸町1-1
{&quot;matched&quot;: &quot;室蘭市幸町1-1&quot;, &quot;candidates&quot;: [{&quot;id&quot;: 19318, &quot;name&quot;: &quot;1-1番地&quot;, &quot;x&quot;: 140.97177124023438, &quot;y&quot;: 42.316184997558594, &quot;level&quot;: 7, &quot;priority&quot;: 99, &quot;note&quot;: &quot;chiban:H000002407&quot;, &quot;fullname&quot;: [&quot;北海道&quot;, &quot;室蘭市&quot;, &quot;幸町&quot;, &quot;1-1番地&quot;]}]}
</div></code></pre>
<p>大字レベルの住所を検索すると &quot;note&quot; 欄に &quot;ooaza:2180&quot; のように大字コードが、地番レベルの住所を検索すると &quot;chiban:H000002407&quot; のように FID がそれぞれ登録されています。大字の代表点の座標も大字ポリゴンから計算したものが利用されています。</p>
<h2 id="%E3%83%87%E3%83%BC%E3%82%BF%E3%82%BB%E3%83%83%E3%83%88">データセット</h2>
<p>&quot;geojson2db&quot; と &quot;geojson2text&quot; にはまだ説明していないオプションがあります。 &quot;--id&quot;・&quot;--title&quot;・&quot;--url&quot; の3つで、いずれも Jageocoder のデータセット (Dataset) に関係します。</p>
<p>Jageocoder ではたとえば国交省の <a href="https://nlftp.mlit.go.jp/isj/">位置参照情報</a> や、デジタル庁の <a href="https://www.digital.go.jp/policies/base_registry_address">アドレス・ベース・レジストリ</a> など、住所データベースの元となるデータ集合を「データセット」と呼びます。位置参照情報データセットには「街区レベル位置参照情報」と「大字・町丁目レベル位置参照情報」が含まれるようにデータセット内のデータが同じ構造を持っている必要はありません。同一の出典とみなせるデータをひとまとめに管理するための集合がデータセットです。</p>
<p>日本の住所は漢字の表記揺れや字・小字の省略などが頻繁に起こるため、同じ住所でも出典によって表記が異なることもよくあります。なので検索結果が「どの情報に由来するのか」を確認できる必要があります。上の例でいえば、大字レベルの住所は「室蘭市地番図」由来であり、地番レベルの住所は「登記所備付地図」由来です。なのでこれらは別々のデータセットとして管理するべきです。</p>
<p>データセットを分けるには &quot;--id&quot; オプションで異なる値を指定します。ただし &quot;id&quot; として指定できるのは1以上99以下の整数に限ります。また、数値だけでは出典が分からなくなってしまうので、 &quot;--title&quot; オプションでデータセットのタイトルを、 &quot;--url&quot; オプションでデータセットに関連するウェブページの URL を登録することができます。</p>
<p>具体的な使い方は次のようになります。</p>
<pre class="hljs"><code><div>dbtool geojson2text --id=1 --title=登記所備付地図 --codekey=chiban --code=ID --pref==北海道 --city=市区町村名 --oaza=大字名 --aza=丁目名 --block={地番}番地 01205__12_r_2024.geojson
dbtool geojson2text --id=2 --title=室蘭市地番図 --codekey=ooaza --code=大字コード --pref==北海道 --city==室蘭市 --oaza=大字名 muroran_oaza-2024.geojson
dbtool text2db --text-dir=texts
</div></code></pre>
<p>これで登記所備付地図由来の住所は &quot;id:1&quot; に、室蘭市地番図由来の住所は &quot;id:2&quot; になります。作成した住所データベースで住所を検索してみます。</p>
<pre class="hljs"><code><div>jageocoder search --db-dir=db 室蘭市幸町
{&quot;matched&quot;: &quot;室蘭市幸町&quot;, &quot;candidates&quot;: [{&quot;id&quot;: 19317, &quot;name&quot;: &quot;幸町&quot;, &quot;x&quot;: 140.97024536132812, &quot;y&quot;: 42.3152961730957, &quot;level&quot;: 5, &quot;priority&quot;: 2, &quot;note&quot;: &quot;ooaza:2180&quot;, &quot;fullname&quot;: [&quot;北海道&quot;, &quot;室蘭市&quot;, &quot;幸町&quot;]}]}
jageocoder search --db-dir=db 室蘭市幸町1-1
{&quot;matched&quot;: &quot;室蘭市幸町1-1&quot;, &quot;candidates&quot;: [{&quot;id&quot;: 19318, &quot;name&quot;: &quot;1-1番地&quot;, &quot;x&quot;: 140.97177124023438, &quot;y&quot;: 42.316184997558594, &quot;level&quot;: 7, &quot;priority&quot;: 1, &quot;note&quot;: &quot;chiban:H000002407&quot;, &quot;fullname&quot;: [&quot;北海道&quot;, &quot;室蘭市&quot;, &quot;幸町&quot;, &quot;1-1番地&quot;]}]}
</div></code></pre>
<p>先ほどとほとんど同じですが、 &quot;priority&quot; に設定した &quot;id&quot; の値が入っていることが確認できます。</p>
<blockquote>
<p>検索結果の属性名が &quot;dataset-id&quot; ではなく &quot;priority&quot; なのは、複数のデータセットが同じ住所を含んでいる場合にどのデータセットを優先するかを決めるためにも利用しているためです。&quot;id&quot; が小さいデータセットの住所が優先されます。</p>
</blockquote>
<p>&quot;--title&quot;・&quot;--url&quot; で指定した値は検索結果には表示されませんが、住所データベースには登録されており、Python API で確認できます。</p>
<pre class="hljs"><code><div>$ python
&gt;&gt;&gt; import jageocoder
&gt;&gt;&gt; jageocoder.init(db_dir=&quot;db&quot;)
&gt;&gt;&gt; jageocoder.searchNode(&quot;幸町130-1&quot;)[0].node.dataset
{'id': 1, 'title': '登記所備付地図', 'url': ''}
&gt;&gt;&gt; jageocoder.searchNode(&quot;幸町&quot;)[0].node.dataset
{'id': 2, 'title': '室蘭市地番図', 'url': ''}
</div></code></pre>
<h1 id="%E5%8F%82%E8%80%83-url">参考 URL</h1>
<ul>
<li>Jageocoder : https://jageocoder.info-proto.com/</li>
<li>Jageocoder データファイル一覧 : https://www.info-proto.com/static/jageocoder/latest/</li>
<li>GeoJSON : https://geojson.org/</li>
<li>QGIS : https://qgis.org/</li>
<li>国土交通省「位置参照情報」 : https://nlftp.mlit.go.jp/isj/</li>
<li>デジタル庁「アドレス・ベース・レジストリ」 : https://www.digital.go.jp/policies/base_registry_address</li>
<li>G空間情報センター「室蘭市地番図2024年」 : https://www.geospatial.jp/ckan/dataset/muroranchiban2024</li>
<li>G空間情報センター「法務省登記所備付地図データ変換済 (北海道室蘭市)」 : https://www.geospatial.jp/ckan/dataset/aigid-moj-01205</li>
</ul>
<h1 id="%E7%B7%A8%E9%9B%86%E5%B1%A5%E6%AD%B4">編集履歴</h1>
<p>初版: 2025-05-01</p>

</body>
</html>
